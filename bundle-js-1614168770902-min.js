function isArray(e){return"[object Array]"===Object.prototype.toString.call(e)}function cel(e){if(!isArray(e))return cel.call(this,Array.prototype.slice.call(arguments));var o=e[0],t=e[1],i=document.createElement(o),n=1;if("object"==typeof t&&null!==t&&!isArray(t)){for(var a in t)i[a]=t[a];n=2}for(var r=n;r<e.length;r++)isArray(e[r])?i.appendChild(cel(e[r])):i.appendChild(document.createTextNode(e[r]));return i}function randomColor(e,o){return"hsl("+e*(360/(o<1?1:o))%360+",100%,50%)"}function randomColor2(){return randomColor(Math.floor(999*Math.random()),100)}function promiseTimeout(e){return new Promise(function(o,t){setTimeout(()=>t(new Error("timeout")),4e3),e.then(o,t)})}function getDistance(e,o){return Math.abs(e[0]-o[0])+Math.abs(e[1]-o[1])}L.TileLayer.mergeOptions({nativeZooms:[]}),L.TileLayer.addInitHook(function(){const e=this.options,o=e.nativeZooms;if(o&&o.length>0){let t,i=100;for(t=0;t<o.length;t++)o[t]<i&&(i=o[t]);e.minZoom=Math.max(e.minZoom,i-1)}}),L.TileLayer.include({getTileSize:function(){const e=this._map,o=L.GridLayer.prototype.getTileSize.call(this),t=this._tileZoom+this.options.zoomOffset,i=this._mapNativeZoom(t);return i==t?o:o.divideBy(e.getZoomScale(i,t)).round()},_getZoomForUrl:function(){let e=this._tileZoom,o=this.options.maxZoom;return this.options.zoomReverse&&(e=o-e),e+=this.options.zoomOffset,this._mapNativeZoom(e)},_mapNativeZoom:function(e){let o=this.options.nativeZooms,t=this.options.minNativeZoom,i=this.options.maxNativeZoom;if(o&&o.length>0){let t,i=-1,n=100;for(t=0;t<o.length;t++)o[t]<=e&&o[t]>i&&(i=o[t]),o[t]<n&&(n=o[t]);e=i<0?n:i}else null!==i&&e>i?e=i:null!==t&&e<t&&(e=t);return e}});const base_folder=is_dev_environment?"../":"./",emoji_folder=base_folder+"images/openmoji/",map_folder=base_folder+"images/maps/",company_emoji_folder=base_folder+"images/companyemoji/",custom_emoji_folder=base_folder+"images/custom/",is_mobile_device=void 0!==window.orientation||-1!==navigator.userAgent.indexOf("IEMobile");let copy_link_url=window.location.protocol+"//"+window.location.host+"/";const params={hideplayers:""===new URL(location.href).searchParams.get("hideplayers"),hideicons:""===new URL(location.href).searchParams.get("hideicons"),coords:(()=>{const e=new URL(location.href).searchParams.get("x"),o=new URL(location.href).searchParams.get("y");return e&&o?[e,o]:void 0})()};localStorage.getItem("ttmap_options_1")&&localStorage.removeItem("ttmap_options_1");const options={current_map_index:1,sidebar_open:!0,current_trail_index:is_mobile_device?3:2,timestamp:0,markers:{business:!0,garages:!0,self_storage:!0,houses:!0}};let currentTileLayer=null;const save_options=()=>{options.timestamp=Date.now(),localStorage.setItem("ttmap_options_2",JSON.stringify(options))};try{const e=localStorage.getItem("ttmap_options_2");if(e&&(Object.assign(options,JSON.parse(e)),params.hideicons))for(const e in options.markers)options.markers[e]=!1;save_options()}catch(e){console.error(e)}const div_map=cel("div",{id:"map"});document.body.appendChild(div_map),div_map.style.height=window.innerHeight+"px",window.onresize=(()=>{div_map.style.height=window.innerHeight+"px"}),L.CRS.Kebab=L.extend({},L.CRS.Simple,{projection:{project:e=>new L.Point(e.lat,e.lng),unproject:e=>new L.LatLng(e.x,e.y),bounds:new L.Bounds([-180,-90],[180,90])},transformation:new L.Transformation(.005175,34.38,-.005173,46.79355)});const map=L.map("map",{renderer:L.canvas(),zoomControl:!1,zooms:[2,3,4,5,6,7,8,9],minZoom:2,maxZoom:9,fadeAnimation:!0,zoomAnimation:!0,crs:L.CRS.Kebab}).setView([0,0],5),map_list=[{name:"Color Mode",bgcolor:"#0fa8d1",tileLayer:L.tileLayer(base_folder+"images/maps/color-mode-tiles/{z}_{x}_{y}.jpg",{tileSize:288,nativeZooms:[3,4,5,6,7],noWrap:!0,bounds:[{lat:-6566,lng:-4735},{lat:7166,lng:8906}],reuseTiles:!0})},{name:"Dark Mode",bgcolor:"#171717",tileLayer:L.tileLayer(base_folder+"images/maps/dark-mode-tiles/{z}_{x}_{y}.jpg",{tileSize:288,nativeZooms:[3,4,5,6,7],noWrap:!0,bounds:[{lat:-6566,lng:-4735},{lat:7166,lng:8906}],reuseTiles:!0})}];L.control.zoom({position:"topright"}).addTo(map);const div_right_click_menu=cel("div",{id:"copy-menu",hidden:!0},["b",{innerText:"Copy link to this position:"}],["br"],["input",{type:"text",id:"copy-link-input-field",value:"",onclick:e=>e.target.select()}],["label",{for:"hidePlayersCheck",innerText:"Hide Players:"}],["input",{type:"checkbox",id:"hidePlayersCheck",checked:!0,onclick:()=>refresh_copy_link()}],["label",{for:"hideIconsCheck",innerText:"Hide Icons:"}],["input",{type:"checkbox",id:"hideIconsCheck",checked:!1,onclick:()=>refresh_copy_link()}]);document.body.appendChild(div_right_click_menu);const div_credits=cel("div",{id:"credits",hidden:!0});document.body.appendChild(div_credits);const div_hud_popup=cel("div",{id:"hud-popup",hidden:!0});document.body.appendChild(div_hud_popup);let active_popup_timeout=null;function assign_hud_hover_event(e){return Object.assign(e,{onmouseover:e=>{if(!e.target._title)return;div_hud_popup.hidden=!1,div_hud_popup.innerText=e.target._title;let o=e.target.offsetTop+e.target.offsetHeight+5;o<0&&(o=0);let t=e.target.offsetLeft+.5*e.target.offsetWidth-.5*div_hud_popup.offsetWidth;t<0&&(t=0),div_hud_popup.style.top=o+"px",div_hud_popup.style.left=t+"px",is_mobile_device&&!active_popup_timeout&&(active_popup_timeout=setTimeout(()=>{div_hud_popup.hidden=!0,div_hud_popup.innerText="",active_popup_timeout=null},1e3))},onmouseleave:e=>{div_hud_popup.hidden=!0,div_hud_popup.innerText=""}})}const div_sidebar=cel("div",{id:"sidebar"});document.body.appendChild(div_sidebar);const sidebar_toggle=e=>{"none"===div_sidebar_panel.style.display?(e.target.className="arrow-close",div_sidebar_panel.style.display="block"):(e.target.className="arrow-open",div_sidebar_panel.style.display="none")},div_sidebar_panel=cel("div",{id:"sidebar-panel"});div_sidebar.appendChild(div_sidebar_panel);const div_sidebar_arrow=cel("a",{href:"#",id:"sidebar-arrow",className:"arrow-close",_title:"Toggle Sidebar",onclick:sidebar_toggle});function create_sideblock_item(e="N/A",...o){div_sidebar_panel.appendChild(cel(["div",{className:"block-item"},["span",{className:"block-item-head",innerText:e}],["div",{className:"block-item-content flx"},...o]]))}div_sidebar.appendChild(div_sidebar_arrow),create_sideblock_item("Map Mode",...map_list.map((e,o)=>["input",assign_hud_hover_event({type:"button",className:"img-btn image-select-btn grow-item",value:e.name,_title:e.title,onclick:()=>toogle_image_quality(o)})]));let current_copy_link_url="";map.on("contextmenu",function(e){div_right_click_menu.style.top=e.originalEvent.y+"px",div_right_click_menu.style.left=e.originalEvent.x+"px",current_copy_link_url=`${copy_link_url}?x=${e.latlng.lat.toFixed(1)}&y=${e.latlng.lng.toFixed(1)}`,refresh_copy_link(),div_right_click_menu.hidden=!1});const copy_link_input_field=document.getElementById("copy-link-input-field"),hide_players_checkbox=document.getElementById("hidePlayersCheck"),hide_icons_checkbox=document.getElementById("hideIconsCheck");function refresh_copy_link(){copy_link_input_field.value=current_copy_link_url+(!0===hide_players_checkbox.checked?"&hideplayers":"")+(!0===hide_icons_checkbox.checked?"&hideicons":"")}function toogle_image_quality(e,o=!1){(o||e!==options.current_map_index)&&(currentTileLayer&&map.removeLayer(currentTileLayer),options.current_map_index=e,(currentTileLayer=map_list[e].tileLayer).addTo(map),div_map.style.backgroundColor=map_list[e].bgcolor,save_options(),refresh_image_quality_button())}function refresh_image_quality_button(){let e=0;for(const o of document.querySelectorAll(".image-select-btn"))e===options.current_map_index?o.classList.add("selected"):o.classList.remove("selected"),e++}function show_credits(){div_credits.hidden=!div_credits.hidden}map.on("click",function(){div_right_click_menu.hidden=!0}),map.on("drag",function(){div_right_click_menu.hidden=!0}),toogle_image_quality(options.current_map_index,!0),fetch(base_folder+"data/credits.txt").then(e=>e.text()).then(e=>{div_credits.appendChild(cel(["p",{innerText:e}])),div_credits.appendChild(cel(["div",{innerText:"Download the map: "},["a",{href:"https://supernovaplus.github.io/ttmap/images/maps/map.jpg",innerText:"COLOR (4608p)",target:"blank"}],["a",{href:"https://supernovaplus.github.io/ttmap/images/maps/mapdark.jpg",innerText:"DARK (4608p)",target:"blank"}],["a",{href:"https://supernovaplus.github.io/ttmap/images/maps/mobilemap.jpg",innerText:"COLOR (2304p)",target:"blank"}],["a",{href:"https://supernovaplus.github.io/ttmap/images/maps/mapdarkmobile.jpg",innerText:"DARK (2304p)",target:"blank"}]])),div_credits.appendChild(cel(["input",{type:"button",value:"close",onclick:show_credits}]))}),map.attributionControl.addAttribution('<a href="#" onclick="show_credits(); return;">CREDITS | Download Map</a>'),create_sideblock_item("Custom Plot",["input",{type:"button",className:"img-btn image-select-btn btn",value:"Show/Hide",onclick:()=>{toggle_plot_window()}}],["div",{id:"plot-input",style:"display:none"},["hr"],["textarea",{id:"coordinates-input-window",style:"width: 170px",placeholder:"paste the coordinates here"}],["input",{type:"button",className:"btn img-btn",value:"try to plot the route",onclick:()=>{convert_the_plot_coordinates()}}],["div",["input",{type:"button",value:"clear",className:"btn img-btn",onclick:()=>{clear_plotline(!0)}}],["p",{id:"custom_plot_message",style:"margin: 0"}],["input",{id:"known-routes-button",type:"button",value:"show known routes",className:"btn img-btn",style:"display:none; background-color:aquamarine",onclick:()=>{toggle_known_routes()}}],["div",{id:"custom-lines-list",style:"display:none; color:black; background-color: aquamarine"}]]]);const known_routes_block_div=document.getElementById("custom-lines-list");function toggle_known_routes(){known_routes_block_div.style.display="none"===known_routes_block_div.style.display?"block":"none"}function fetch_known_route(e){fetch("https://aca.lt/api_v1/snowplow/"+e).then(e=>e.text()).then(e=>{div_plot_textarea.value=e,convert_the_plot_coordinates()}).catch(e=>{console.log(e),div_custom_plot_message.innerText="Server error"})}fetch("https://aca.lt/api_v1/snowplow/list.json").then(e=>e.json()).then(e=>{document.getElementById("custom-lines-list").append(cel(["ul",...e.map(e=>["li",["a",{type:"src",href:"#",innerText:e[0],className:"lines-list-item",onclick:()=>{fetch_known_route(e[1])}}]])])),document.getElementById("known-routes-button").style.display="block"}).catch(e=>console.log(e));const div_custom_plot=document.getElementById("plot-input"),div_custom_plot_message=document.getElementById("custom_plot_message"),div_plot_textarea=document.getElementById("coordinates-input-window");function toggle_plot_window(){div_custom_plot.style.display="none"===div_custom_plot.style.display?"block":"none"}div_plot_textarea.value="";let custom_plot_line=null,custom_plot_line_joint=null;function clear_plotline(e=!1){custom_plot_line&&(map.removeLayer(custom_plot_line),map.removeLayer(custom_plot_line_joint),custom_plot_line=null,custom_plot_line_joint=null),!0===e&&(div_plot_textarea.value="",div_custom_plot_message.innerText="")}function convert_the_plot_coordinates(){let e=div_plot_textarea.value;(!e||e.length<10)&&(div_custom_plot_message.innerText="Invalid string");const o=[];let t="",i=0;for(;e;)try{let n=/\{name = \"([\.a-zA-Z0-9\- \']+)\", x = (-?[0-9.]+), y = (-?[0-9.]+), z = (-?[0-9.]+), h = ([0-9.]+)\}/gm.exec(e);if(!n)break;if(n[1]&&n[2]&&n[3]&&n[4]&&!isNaN(n[2])&&!isNaN(n[3])&&!isNaN(n[4])&&o.push({name:n[1],x:parseFloat(n[2]),y:parseFloat(n[3]),h:parseFloat(n[4])}),i>3)break;n[0]===t?i++:i=0,t=n[0],e=n.input.replace(n[1],"")}catch(e){console.log(e);break}if(clear_plotline(),o.length>1){custom_plot_line=L.polyline(o.map(e=>[e.x,e.y]),{color:"red",weight:2}).addTo(map),custom_plot_line_joint=L.polyline([[o[0].x,o[0].y],[o[o.length-1].x,o[o.length-1].y]],{color:"pink",weight:2}).addTo(map);const e=parseInt(.5*o.length);map.flyTo([o[e].x,o[e].y],5,{animate:!0,duration:.5}),div_custom_plot_message.innerText="Done"}else div_custom_plot_message.innerText="Invalid data"}const job_icons={conductor:"🚂",busdriver:"🚌",cargopilot:"✈️",pilot:"✈️",racer:"🏎️",emergency:"🚑",helicopterpilot:"🚁",fisher:"🦈",trucker:"🚛",hunter:"🐗",mechanic:"🛠️",farmer:"🚜",leisurepilot:"⛱️",miner:"⛏️",garbage:"🗑️",cleanup:"🏖️",postop:"✉️",delivery_ups:"📦",taxi:"🚕",firefighter:"🚒",quarry:"💎",metermaid:"🅿️",aerialfire:"🚒✈️",dockhandler:"⚓",delivery_transformer:"⚡",frllc_paramedic:`<img src='${company_emoji_folder}frllc_tag.png'> `,collinsco_cabbie_job:`<img src='${company_emoji_folder}coco_tag.png'> `,collinsco_plane_job:`<img src='${company_emoji_folder}coco_tag.png'> `,collinsco_train_job:`<img src='${company_emoji_folder}coco_tag.png'> `,collinsco_metro_job:`<img src='${company_emoji_folder}coco_tag.png'> `,collinsco_boat_job:`<img src='${company_emoji_folder}coco_tag.png'> `,ia_pilot:`<img src='${company_emoji_folder}ia_tag.png'> `,delivery_iaa:`<img src='${company_emoji_folder}ia_tag.png'> `,rts_job:`<img src='${company_emoji_folder}rts_tag.png'> `,rts_job_air:`<img src='${company_emoji_folder}rts_tag.png'> `,rts_professional:`<img src='${company_emoji_folder}rts_tag.png'> `,pigs_job:`<img src='${company_emoji_folder}pigs_tag.png'> `},vehicle_icons={0:emoji_folder+"1F697.png",1:emoji_folder+"1F697.png",2:emoji_folder+"1F699.png",3:emoji_folder+"1F697.png",4:emoji_folder+"1F697.png",5:emoji_folder+"1F697.png",6:emoji_folder+"1F3CE.png",7:emoji_folder+"1F3CE.png",8:emoji_folder+"1F3CD.png",9:emoji_folder+"1F699.png",10:emoji_folder+"1F697.png",11:emoji_folder+"1F69A.png",12:emoji_folder+"1F69A.png",13:emoji_folder+"1F6B2.png",14:custom_emoji_folder+"boat.png",15:emoji_folder+"1F681.png",16:emoji_folder+"1F6EB.png",17:emoji_folder+"1F697.png",18:emoji_folder+"1F693.png",19:custom_emoji_folder+"trucktrailer.png",20:custom_emoji_folder+"trucktrailer.png",21:emoji_folder+"1F682.png",101:emoji_folder+"1F6B6-200D-2642-FE0F.png",102:emoji_folder+"1F6F8.png",103:emoji_folder+"1F68C.png",104:emoji_folder+"1F69C.png",105:custom_emoji_folder+"trashtruck.png",106:custom_emoji_folder+"towtruck.png",107:emoji_folder+"1F692.png",108:emoji_folder+"1F691.png",109:custom_emoji_folder+"firefighter_airplane.png",110:custom_emoji_folder+"excavator.png",111:emoji_folder+"1F69B.png"},vehicle_classes=["Compacts","Sedans","SUVs","Coupes","Muscle","Sports","Sports","Super","Motorcycles","Off-Road","Industrial","Utility","Vans","Cycles","Boats","Helicopters","Planes","Service","Emergency","Military","Commercial","Trains"];function generate_icon(e,o,t=40){let i=vehicle_icons[e.vehicle_class]||vehicle_icons[0];return"land"===e.vehicle_type?17===e.vehicle_class?/(bus|coach|ikarus)/i.test(e.vehicle_label)?i=vehicle_icons[103]:"TRASH"===e.vehicle_label&&(i=vehicle_icons[105]):18===e.vehicle_class?"FIRETRUK"===e.vehicle_label?i=vehicle_icons[107]:/(GRANGER|emsnspeedo|AMBULAN|RETROAMBU)/i.test(e.vehicle_label)&&(i=vehicle_icons[108]):11===e.vehicle_class&&/tractor/i.test(e.vehicle_label)?i=vehicle_icons[104]:10===e.vehicle_class?"excavator"===e.vehicle_label?i=vehicle_icons[110]:/flatbed/i.test(e.vehicle_label)&&(i=vehicle_icons[106]):20===e.vehicle_class&&/mule/i.test(e.vehicle_label)&&(i=vehicle_icons[111]):i="plane"===e.vehicle_type?"aerialfire"===o.group?vehicle_icons[109]:vehicle_icons[16]:"deluxo"===e.vehicle_type?vehicle_icons[102]:"helicopter"===e.vehicle_type?vehicle_icons[15]:"train"===e.vehicle_type?vehicle_icons[21]:"boat"===e.vehicle_type?vehicle_icons[14]:vehicle_icons[101],L.icon({iconUrl:i,iconSize:[t,t],iconAnchor:[20,20],popupAnchor:[0,-20]})}const business_icons={Business:`${company_emoji_folder}22px-Business_Owned.png`,"Watercraft Garage":`${company_emoji_folder}25px-Boat_Garage.png`,"Helicopter Garage":`${company_emoji_folder}25px-Helicopter_Garage.png`,"Aircraft Garage":`${company_emoji_folder}25px-Aircraft_Garage.png`,"Vehicle Garage":`${company_emoji_folder}25px-Garage.png`,"Car Garage":`${company_emoji_folder}25px-Garage.png`,"Self Storage":`${company_emoji_folder}22px-Self_Storage.png`,House:`${company_emoji_folder}22px-House.png`,"Custom Point":`${company_emoji_folder}point22px.png`},static_markers_list={business:{title:"Businesses",image:business_icons.Business,markers:[]},garages:{title:"Garages",image:business_icons["Vehicle Garage"],markers:[]},self_storage:{title:"Self Storages",image:business_icons["Self Storage"],markers:[]},houses:{title:"Houses",image:business_icons.House,markers:[]}};function toggle_markers(e){options.markers[e]?(static_markers_list[e].markers.forEach(e=>{map.removeLayer(e)}),options.markers[e]=!1):(static_markers_list[e].markers.forEach(e=>{map.addLayer(e)}),options.markers[e]=!0),save_options(),refresh_toggle_markers_buttons()}function refresh_toggle_markers_buttons(){for(const e of document.querySelectorAll(".toggle-markers"))options.markers[e._key]?e.classList.add("selected"):e.classList.remove("selected")}function create_data_marker_icon(e){return L.icon({iconUrl:business_icons[e],iconSize:[22,23],iconAnchor:[11,11.5],popupAnchor:[0,0],className:"dataicon"})}create_sideblock_item("Toggle Makers",...Object.entries(static_markers_list).map(e=>["img",assign_hud_hover_event({className:"img-btn toggle-markers",src:e[1].image,_key:e[0],_title:e[1].title,_title:e[1].title,onclick:()=>toggle_markers(e[0])})])),refresh_toggle_markers_buttons(),fetch(base_folder+"data/bizBlips.json").then(e=>e.json()).then(e=>{for(const o in e){const t=L.marker([e[o].coordinates.x,e[o].coordinates.y],{icon:create_data_marker_icon("Business")}).bindPopup(`<div class="popup-header green-bg">${e[o].name}</div>\n        Type: Business<hr>\n        Price: ${e[o].price}<hr>\n        Perks:<br>${e[o].perks.join("<br>")}<hr>\n        Payout: ${e[o].payout}<br>\n        <small>(in 24 hours / 8 stacks)</small>`);static_markers_list.business.markers.push(t),options.markers.business&&map.addLayer(t)}}),fetch(base_folder+"data/garageBlips.json").then(e=>e.json()).then(e=>{for(const o in e){const t=L.marker([e[o].coordinates.x,e[o].coordinates.y],{icon:create_data_marker_icon(e[o].type)}).bindPopup(`<div class="popup-header blue-bg">${e[o].name}</div>\n        Type: ${e[o].type}<hr>\n        Spawns: ${e[o].spawns}`);t._name=e[o].name,static_markers_list.garages.markers.push(t),options.markers.garages&&map.addLayer(t)}}),fetch(base_folder+"data/ssBlips.json").then(e=>e.json()).then(e=>{for(const o in e){const t=L.marker([e[o].coordinates.x,e[o].coordinates.y],{icon:create_data_marker_icon("Self Storage")}).bindPopup(`<div class="popup-header blue-bg">${e[o].name}</div>\n        Type: Self Storage Unit<hr>\n        Fee: ${e[o].fee}<hr>\n        Capacity: ${e[o].capacity}`);static_markers_list.self_storage.markers.push(t),options.markers.self_storage&&map.addLayer(t)}}),fetch(base_folder+"data/houses.json").then(e=>e.json()).then(e=>{e.data.forEach(e=>{const o=L.marker([e.position.x,e.position.y],{icon:create_data_marker_icon("House")}).bindPopup(`<div class="popup-header blue-white">${e.name}</div>\n        Buy Price: $${Number(e.buy_price).toLocaleString()}<br>\n        Sell Price: $${Number(e.sell_price).toLocaleString()}`);static_markers_list.houses.markers.push(o),options.markers.houses&&map.addLayer(o)})}),params.coords&&(L.marker(params.coords,{icon:create_data_marker_icon("Custom Point")}).bindTooltip("Location").addTo(map),map.flyTo(params.coords,6,{animate:!0,duration:.5}));const nova_servers={},trail_modes=[{name:"LONG",title:"1000 points length",value:1e3},{name:"MEDIUM",title:"500 points length",value:500},{name:"SHORT",title:"100 points length",value:100},{name:"NONE",title:"0 points length",value:0}];function handle_find_player(e){if(!e.previousSibling.value)return;const o=String(e.previousSibling.value).toLowerCase();let t;for(const e in nova_servers){if(t)break;if(!nova_servers[e].disabled)for(const i in nova_servers[e].players)if(String(nova_servers[e].players[i].gameid).toLowerCase().includes(o)){t=nova_servers[e].players[i];break}}if(t)return e.previousSibling.style.backgroundColor="lime",map.flyTo(t.marker._latlng,7,{animate:!0,duration:.5}),setTimeout(()=>{t.marker.openPopup()},100),!1;e.previousSibling.style.backgroundColor="red"}function toggle_trail_mode(e){options.current_trail_index=e,save_options(),refresh_trail_mode_buttons()}function refresh_trail_mode_buttons(){let e=0;for(const o of document.querySelectorAll(".trails-btn"))e===options.current_trail_index?o.classList.add("selected"):o.classList.remove("selected"),e++}function get_server_data(e){!0!==e.disabled&&fetch("https://novaplus.herokuapp.com/positions/"+e.ip).then(e=>e.json()).then(o=>{if(!o.data||o.error||0===o.data.players.length||!0===e.disabled)return console.log(e.name,o.error?o.error:"no res data / no players / checkbox unmarked"),void disable_server(e);const t=Date.now();e.timestamp=t;const i=o.data.players;for(let o=0;o<i.length;o++){if(null===i[o][3])continue;const n=i[o][2];if("null"!==i[o][0])if(void 0===e.players[n]){if(e.players[n]={marker:null,polyline:null,gameid:i[o][0]+"#"+n,timestamp:t,vehicle:i[o][4],job:i[o][5],positions_cache:[],positions_cache_last_index:0,color:randomColor2()},e.players[n].marker=L.marker([i[o][3].x,i[o][3].y],{icon:generate_icon(i[o][4],i[o][5],40)}).addTo(map).bindPopup(generate_popup(i[o],e,e.players[n].color)).bindTooltip(generate_job_tag(i[o][5].group,e.players[n].gameid),{permanent:!1,offset:[0,-5],opacity:.8,direction:"top"}).setZIndexOffset(1e3),3!==options.current_trail_index&&i[o][6]&&i[o][6].length>1){e.players[n].positions_cache_last_index=i[o][6][i[o][6].length-1][0];for(let t=0;t<i[o][6].length;t++){const a=i[o][6][t],r=i[o][6][t+1];r&&getDistance([a[1],a[2]],[r[1],r[2]])>200?e.players[n].positions_cache.length=0:e.players[n].positions_cache.push([a[1],a[2]])}}e.players[n].polyline=L.polyline(e.players[n].positions_cache,{color:e.players[n].color,weight:2}).addTo(map),e.players[n].polyline.on("click",o=>{e.players[n].marker.openPopup(),setTimeout(()=>{map.flyTo(e.players[n].marker._latlng,7,{animate:!0,duration:.5})},100)})}else{if(3!==options.current_trail_index&&i[o][6]&&i[o][6].length>2){for(let t=0;t<i[o][6].length;t++){if(i[o][6][t][0]<=e.players[n].positions_cache_last_index)continue;const a=i[o][6][t],r=i[o][6][t+1];r&&getDistance([a[1],a[2]],[r[1],r[2]])>200?e.players[n].positions_cache.length=0:e.players[n].positions_cache.push([a[1],a[2]])}e.players[n].positions_cache_last_index=i[o][6][i[o][6].length-1][0]}for(;e.players[n].positions_cache.length>trail_modes[options.current_trail_index].value;)e.players[n].positions_cache.shift();e.players[n].polyline.setLatLngs(e.players[n].positions_cache),e.players[n].timestamp=t,e.players[n].marker.setLatLng({lat:i[o][3].x,lng:i[o][3].y});let a=!1;e.players[n].vehicle.vehicle_model!==i[o][4].vehicle_model&&(e.players[n].marker.setIcon(generate_icon(i[o][4],i[o][5])),e.players[n].vehicle=i[o][4],a=!0),e.players[n].job.name!==i[o][5].name&&(e.players[n].marker._tooltip.setContent(generate_job_tag(i[o][5].group,e.players[n].gameid)),e.players[n].job=i[o][5],a=!0),(a||"plane"===i[o][4].vehicle_type||"helicopter"===i[o][4].vehicle_type)&&e.players[n].marker.setPopupContent(generate_popup(i[o],e,e.players[n].color))}else void 0!==e.players[n]&&(map.removeLayer(e.players[n].marker),delete e.players[n])}server_cleanup(e),e.timeout||(e.timeout=setTimeout(()=>{get_server_data(e),e.timeout=null},6e3))}).catch(o=>{console.log(o),disable_server(e)})}function disable_server(e){e.checkbox.checked=!1,e.disabled=!0,e.timeout&&(clearTimeout(e.timeout),e.timeout=null),server_cleanup(e,!0)}function enable_server(e){e.checkbox.checked=!0,e.disabled=!1,e.timeout||get_server_data(e)}function servers_check_all(){for(const e in nova_servers)nova_servers[e].disabled&&enable_server(nova_servers[e])}function servers_uncheck_all(){for(const e in nova_servers)nova_servers[e].disabled||disable_server(nova_servers[e])}function server_cleanup(e,o=!1){for(const t in e.players)(o||e.players[t].timestamp<Date.now()-49e3)&&(map.removeLayer(e.players[t].marker),e.players[t].polyline&&map.removeLayer(e.players[t].polyline),delete e.players[t])}function generate_popup(e,o,t){return`<div class="popup-header" ${t?`style="background-color: ${t}"`:""}>${e[0]}</div>\n        <b>ID:</b> ${e[2]}<hr>\n        <b>Job:</b> ${(e[5].name||"N/A")+" "+generate_job_tag(e[5].group)}<hr>\n        <b>Vehicle</b>: ${"NULL"===e[4].vehicle_label?"N/A":`${e[4].vehicle_name} (${vehicle_classes[e[4].vehicle_class]})`}<hr>\n        ${"plane"===e[4].vehicle_type||"helicopter"===e[4].vehicle_type?`<b>Height</b>: ${parseInt(e[3].z)}<hr>`:""}\n        \n        <b>${o.name}</b> ${is_mobile_device?"":`<a href="fivem://connect/${o.ip}" title="Join: ${o.name}">JOIN</a>`}`}function generate_job_tag(e,o=""){return void 0===job_icons[e]?o:job_icons[e]+o}fetch(base_folder+"data/serversList.json").then(e=>e.json()).then(async e=>{create_sideblock_item("Trail Mode",...trail_modes.map((e,o)=>["input",assign_hud_hover_event({type:"button",className:"img-btn grow-item trails-btn",_title:e.title,value:e.name,onclick:()=>toggle_trail_mode(o)})])),refresh_trail_mode_buttons(),create_sideblock_item("Find Player",["input",{type:"text",id:"find-player-input",placeholder:"Enter player's ID or name",onkeydown:({keyCode:e,target:o})=>{13===e&&handle_find_player(o.nextSibling)}}],["input",{type:"button",className:"btn img-btn",value:"Find",onclick:e=>handle_find_player(e.target)}]),create_sideblock_item("Servers",["div",{id:"servers"}],["input",{type:"button",className:"btn img-btn",onclick:e=>{e.target.disabled=!0,setTimeout(()=>{e.target.disabled=!1},6e3),servers_check_all()},value:"Check All"}],["br"],["input",{type:"button",className:"btn img-btn",onclick:e=>{e.target.disabled=!0,setTimeout(()=>{e.target.disabled=!1},6e3),servers_uncheck_all()},value:"Uncheck All (Hide Players)",style:"width: -moz-available;"}]);const o=document.getElementById("servers");for(let t=0;t<e.length;t++){const i=cel(["div",{className:"servercheckbox"},["input",{type:"checkbox",checked:!1}],["span",{innerText:e[t][1]}],!1===is_mobile_device?["a",assign_hud_hover_event({href:"fivem://connect/"+e[t][0],_title:"Join: "+e[t][0],innerText:"🎮"})]:[]]);o.appendChild(i),nova_servers[e[t][0]]={name:e[t][1],ip:e[t][0],players:{},timestamp:0,checkbox:i.firstElementChild,disabled:!0,timeout:null},nova_servers[e[t][0]].checkbox.addEventListener("change",()=>{nova_servers[e[t][0]].disabled?enable_server(nova_servers[e[t][0]]):disable_server(nova_servers[e[t][0]])})}if(!params.hideplayers){const e=Object.keys(nova_servers)[0];"https:"===window.location.protocol?enable_server(Object.values(nova_servers)[0]):fetch(`http://${nova_servers[e].ip}/status/widget/players.json`).then(e=>e.json()).then(o=>{o&&o.players&&o.players.length>0?enable_server(nova_servers[e]):disable_server(nova_servers[e])}).catch(o=>{disable_server(nova_servers[e]);for(const o in nova_servers)o!==e&&fetch(`http://${nova_servers[o].ip}/status/widget/players.json`).then(e=>e.json()).then(e=>{e&&e.players&&e.players.length>0?enable_server(nova_servers[o]):disable_server(nova_servers[o])}).catch(e=>{disable_server(nova_servers[o])})})}}).catch(e=>{console.log(e)});